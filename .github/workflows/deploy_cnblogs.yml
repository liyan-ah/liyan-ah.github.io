name: Deploy to CNBlogs

on:
    push:
        branches: [master]

jobs:
    build:
        runs-on: ubuntu-latest

        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Copy content to content_cnblogs
              run: cp -r content content_cnblogs

            - name: Process CNBlogs content
              run: |
                  #!/bin/bash

                  process_directory() {
                    local dir="$1"

                    for item in "$dir"/*; do
                      if [ -d "$item" ]; then
                        local basename=$(basename "$item")
                        # 跳过 pages 目录
                        if [ "$basename" != "pages" ] && [ "$basename" != "_index.md" ]; then
                          local index_file="$item/index.md"

                            if [ -f "$index_file" ]; then
                              # 提取信息
                              local title=$(grep "^title" "$index_file" | awk -F '=' '{print $2}' | sed 's/^[[:space:]]*["'"'"']//; s/["'"'"'][[:space:]]*$//')
                              local description=$(grep "^description" "$index_file" | awk -F '=' '{print $2}' | sed 's/^[[:space:]]*["'"'"']//; s/["'"'"'][[:space:]]*$//')
                              local date=$(grep "^date" "$index_file" | awk -F '=' '{print $2}' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')
                            local categories=$(grep "^categories" "$index_file" | head -1)
                            local tags=$(grep "^tags" "$index_file" | head -1)

                            # 将日期转换为时间戳（格式：YYYYMMDD）
                            local datestamp=$(echo "$date" | sed 's/[-:]//g' | cut -c1-8)

                            if [ -n "$datestamp" ]; then
                              # 提取分类和标签，转换为 YAML 格式
                              local category_list=""
                              local tag_list=""

                              # 处理分类
                              if [ -n "$categories" ]; then
                                # 从 categories = ["分类1", "分类2"] 提取内容
                                category_list=$(echo "$categories" | sed 's/categories.*=\s*//; s/\[//; s/\]//; s/"//g; s/'\''//g')
                              fi

                              # 处理标签
                              if [ -n "$tags" ]; then
                                # 从 tags = ["标签1", "标签2"] 提取内容
                                tag_list=$(echo "$tags" | sed 's/tags.*=\s*//; s/\[//; s/\]//; s/"//g; s/'\''//g')
                              fi

                              # 移除 Front Matter 并获取正文
                              local content=$(sed '1,/^+++$/{ /^+++$/{ N; d; }; d; }' "$index_file")

                              # 创建新文件
                              local new_file="$item/${datestamp}.md"

                              # 创建新的 Front Matter（YAML 格式）
                              {
                                echo "---"
                                echo "title: $title"
                                echo "description: $description"
                                echo "tags: $tag_list"
                                echo "category: $category_list"
                                echo "---"
                                echo ""
                                echo "$content"
                              } > "$new_file"
                              
                              echo "Processed: $item -> ${datestamp}.md"
                            fi
                          fi
                        fi
                      fi
                    done
                  }

                  process_directory "content_cnblogs"

            - name: Checkout cnblogs branch
              run: |
                  git fetch origin cnblogs:cnblogs || git checkout -b cnblogs
                  git checkout cnblogs

            - name: Replace content in cnblogs branch
              run: |
                  rm -rf content
                  mv content_cnblogs content

            - name: Commit and push to cnblogs
              run: |
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git add -A
                  git commit -m "Update CNBlogs content from master" || exit 0
                  git push -u origin cnblogs

            - name: Cleanup on master
              run: |
                  git checkout master
                  rm -rf content_cnblogs
                  git config user.name "GitHub Actions"
                  git config user.email "actions@github.com"
                  git add -A
                  git commit -m "Clean up CNBlogs temporary content" || exit 0
                  git push origin master
